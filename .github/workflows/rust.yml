name: Rust CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    if: github.repository_owner == github.actor || github.event.sender.type == 'User'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - x86_64-unknown-linux-gnu
          - aarch64-unknown-linux-gnu
          - x86_64-unknown-linux-musl
          - x86_64-pc-windows-msvc
          - aarch64-pc-windows-msvc
          - x86_64-apple-darwin
          - aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        run: cargo install cross

      - name: Install fd (Linux)
        if: matrix.target == 'x86_64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y fd-find
          sudo ln -sf $(which fdfind) /usr/local/bin/fd

      - name: Install fd (macOS)
        if: matrix.target == 'x86_64-apple-darwin'
        run: brew install fd

      - name: Install fd (Windows)
        if: matrix.target == 'x86_64-pc-windows-msvc'
        run: choco install fd -y

      - name: Verify fd
        if: |
          matrix.target == 'x86_64-unknown-linux-gnu' ||
          matrix.target == 'x86_64-apple-darwin' ||
          matrix.target == 'x86_64-pc-windows-msvc'
        run: fd --version

      - name: Build (cross)
        run: cross build --release --locked --target ${{ matrix.target }}

      - name: Test (native targets only)
        if: |
          matrix.target == 'x86_64-unknown-linux-gnu' ||
          matrix.target == 'x86_64-apple-darwin' ||
          matrix.target == 'x86_64-pc-windows-msvc'
        run: cross test --release --locked --target ${{ matrix.target }}

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt,clippy
      - name: Run Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  fmt:
    name: Formatting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
          components: rustfmt
      - name: Check Formatting
        run: cargo fmt --all -- --check

  audit:
    name: Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: stable
      - name: Cache cargo-audit
        uses: actions/cache@v4
        with:
          path: ~/.cargo/bin/cargo-audit
          key: cargo-audit-bin-v1
      - name: Install cargo-audit (if missing)
        run: |
          if ! command -v cargo-audit &> /dev/null; then
            cargo install cargo-audit
          fi
      - name: Run Audit
        run: cargo audit --deny warnings
