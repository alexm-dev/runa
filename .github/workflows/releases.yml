name: Release runa Cross-Platform Binaries

on:
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag (e.g., v0.3.4)'
        required: true

permissions:
  contents: write

jobs:
  build:
    if: github.actor == 'alexm-dev'
    name: Build (${{ matrix.target }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            platform: linux-x86_64-gnu
            use_cross: true
          - target: aarch64-unknown-linux-gnu
            os: ubuntu-latest
            platform: linux-aarch64-gnu
            use_cross: true
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            platform: linux-x86_64-musl
            use_cross: true
          - target: aarch64-unknown-linux-musl
            os: ubuntu-latest
            platform: linux-aarch64-musl
            use_cross: true
          # Windows
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            platform: windows-x86_64
            use_cross: false
          - target: aarch64-pc-windows-msvc
            os: windows-latest
            platform: windows-aarch64
            use_cross: false
          # macOS
          - target: x86_64-apple-darwin
            os: macos-latest
            platform: macos-x86_64
            use_cross: false
          - target: aarch64-apple-darwin
            os: macos-latest
            platform: macos-aarch64
            use_cross: false

    steps:
      - uses: actions/checkout@v6

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross
        if: ${{ matrix.use_cross }}
        env:
          CROSS_VERSION: "v0.2.5"
          PACKAGE_NAME: "cross-x86_64-unknown-linux-gnu.tar.gz"
          GH_TOKEN: "${{ secrets.GITHUB_TOKEN }}"
        run: |
          INSTALL_DIR="$HOME/.local/bin"
          mkdir -p "$INSTALL_DIR"

          echo "Downloading cross $CROSS_VERSION using gh CLI..."
          gh release download "v0.2.5" \
            --repo cross-rs/cross \
            --pattern "cross-x86_64-unknown-linux-gnu.tar.gz" \
            -D "$INSTALL_DIR"

          tar -xzf "$INSTALL_DIR/cross-x86_64-unknown-linux-gnu.tar.gz" -C "$INSTALL_DIR"
          echo "$INSTALL_DIR" >> $GITHUB_PATH

      - name: Build
        shell: bash
        run: |
          if [[ "${{ matrix.use_cross }}" == "true" ]]; then
            cross build --release --locked --target ${{ matrix.target }}
          else
            cargo build --release --locked --target ${{ matrix.target }}
          fi

      - name: Prepare binary (Linux/macOS)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p dist
          BIN_SRC="target/${{ matrix.target }}/release/rn"
          BIN_DEST="dist/$(basename $BIN_SRC)"
          cp "$BIN_SRC" "$BIN_DEST"
          chmod +x "$BIN_DEST"

      - name: Prepare binary (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $targetDir = "target/${{ matrix.target }}/release"
          $binName = "rn.exe"
          $binPath = Join-Path $targetDir $binName

          Write-Host "Looking for binary at $binPath"
          if (-Not (Test-Path $binPath)) {
            Write-Error "Binary not found: $binPath"
            exit 1
          }

          mkdir dist -ErrorAction SilentlyContinue
          Copy-Item $binPath "dist\$binName" -Force

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: bin-${{ matrix.platform }}
          path: dist/rn*

  checksums_and_archives:
    if: github.actor == 'alexm-dev'
    needs: build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Organize release assets for archiving
        shell: bash
        run: |
          for dir in artifacts/bin-*; do
            platform=${dir#artifacts/bin-}
            outdir="$dir/runa-$platform"
            mkdir -p "$outdir/docs"

            if [ -f "$dir/rn.exe" ]; then
              mv "$dir/rn.exe" "$outdir/"
            elif [ -f "$dir/rn" ]; then
              mv "$dir/rn" "$outdir/"
            fi
            cp README.md LICENSE-MIT LICENSE-APACHE "$outdir/"
            cp docs/configuration.md "$outdir/docs/"
            cp CHANGELOG.md "$outdir/docs/"
          done

      - name: Create archives
        shell: bash
        run: |
          mkdir -p dist
          for dir in artifacts/bin-*; do
            platform=${dir#artifacts/bin-}
            outdir="runa-$platform"

            if [[ "$platform" == *"windows"* ]]; then
              (cd "$dir" && zip -r "../../dist/${outdir}.zip" "$outdir")
            else
              tar -czvf "dist/${outdir}.tar.gz" -C "$dir" "$outdir"
            fi
          done

      - name: Calculate SHA256SUMS
        shell: bash
        run: |
          cd dist
          sha256sum * > SHA256SUMS.txt
          cat SHA256SUMS.txt

      - name: Extract changelog section
        id: extract_changelog
        shell: bash
        run: |
          VERSION=$(echo "${{ github.event.inputs.tag }}" | sed 's/^v//')
          sed 's/\r//' CHANGELOG.md > clean_changelog.md
          awk -v ver="$VERSION" '
            BEGIN { ver_pattern = "\\[v?" ver "\\]" }
            $0 ~ "^#+ " ver_pattern { p=1; next }
            p && ($0 ~ "^---" || $0 ~ "^## \\[") { p=0; exit }
            p { print }
          ' clean_changelog.md > release_notes.md
          sed -i -e :a -e '/^\n*$/{$d;N;ba' -e '}' release_notes.md
          if [ ! -s release_notes.md ]; then
            echo "Error: Extraction failed for version $VERSION"
            exit 1
          fi

      - name: Fail if release exists
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.inputs.tag }}
        run: |
          if gh release view "$TAG" >/dev/null 2>&1; then
            echo "Release $TAG already exists. Aborting."
            exit 1
          fi

      - name: Create release and upload assets
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          TAG: ${{ github.event.inputs.tag }}
        run: |
          gh release create "$TAG" dist/* --title "runa $TAG" --notes-file release_notes.md
